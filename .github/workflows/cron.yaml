name: SPY Preopen Trigger

on:
  schedule:
    # 6:25 AM PT during DST (switch to 25 14 after clocks fall back)
    - cron: '25 13 * * 1-5'
  workflow_dispatch:

jobs:
  call_api:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Call SPY API (with retries)
        id: call
        shell: bash
        run: |
          set -euo pipefail

          URL="https://spy-preopen-api.onrender.com/predict"
          BODY="{\"test_value\":42}"
          RES=""

          # Try up to 5 times (Render cold start protection)
          for i in {1..5}; do
            RES="$(curl -sS -m 20 -X POST "$URL" \
                    -H "Content-Type: application/json" \
                    -d "$BODY" || true)"

            # Stop retrying if it parses as JSON
            echo "$RES" | jq . >/dev/null 2>&1 && break
            echo "Attempt $i did not return JSON (cold start?). Sleeping 5s..."
            sleep 5
          done

          echo "Response (first 200 chars):"
          echo "$RES" | head -c 200; echo

          # Save a minified JSON into this step's output
          if echo "$RES" | jq -e . >/dev/null 2>&1; then
            echo "res=$(echo "$RES" | jq -c .)" >> "$GITHUB_OUTPUT"
          else
            # If not JSON, still pass something downstream so email isn't blank
            echo 'res={"model_call":"UNKNOWN","confidence":0.0,"guidance":"No guidance","features":{}}' >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare email (parse + compose)
        id: prep
        shell: bash
        run: |
          JSON='${{ steps.call.outputs.res }}'
          echo "Raw JSON:"
          echo "$JSON"

          MODEL=$(echo "$JSON" | jq -r '.model_call // empty')
          CONF=$(echo "$JSON" | jq -r '.confidence // empty')
          GUID=$(echo "$JSON" | jq -r '.guidance // empty')
          FEAT=$(echo "$JSON" | jq -c '.features // empty')

          # Fallbacks so the email never arrives blank
          [ -z "$MODEL" ] && MODEL="UNKNOWN"
          [ -z "$CONF" ] && CONF="0.0"
          [ -z "$GUID" ] && GUID="No guidance"
          [ -z "$FEAT" ] && FEAT="{}"

          echo "Model: $MODEL"
          echo "Confidence: $CONF"
          echo "Guidance: $GUID"
          echo "Features: $FEAT"

          echo "subject=SPY Pre-Open: $MODEL (conf $CONF)" >> "$GITHUB_OUTPUT"
          printf "body<<EOF\nDirection: %s\nConfidence: %s\nGuidance: %s\nFeatures: %s\nTime: %s\nEOF\n" \
            "$MODEL" "$CONF" "$GUID" "$FEAT" "${{ github.run_started_at }}" >> "$GITHUB_OUTPUT"

      - name: Email me the prediction
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ secrets.MAIL_USERNAME }}
          from: "SPY Bot <${{ secrets.MAIL_USERNAME }}>"
          subject: ${{ steps.prep.outputs.subject }}
          body: ${{ steps.prep.outputs.body }}
