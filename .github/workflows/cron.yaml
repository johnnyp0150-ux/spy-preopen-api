name: SPY Preopen Trigger

on:
  schedule:
    # 6:25 AM PT during DST (switch to 25 14 after clocks fall back)
    - cron: '25 13 * * 1-5'
  workflow_dispatch:

jobs:
  call_api:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Call SPY API (with retries)
        id: call
        shell: bash
        run: |
          set -e
          URL="https://spy-preopen-api.onrender.com/predict"
          BODY='{"test_value":42}'

          # Try up to 5 times in case the API is cold-starting
          for i in {1..5}; do
            RES=$(curl -sS -m 20 -X POST "$URL" \
              -H "Content-Type: application/json" \
              -d "$BODY" || true)

            # Break if the response looks like JSON
            echo "$RES" | jq . >/dev/null 2>&1 && break
            echo "Attempt $i returned non-JSON (cold start?). Retrying in 5sâ€¦"
            sleep 5
          done

          echo "Response: $RES"
          echo "res=$RES" >> "$GITHUB_OUTPUT"

      - name: Parse values
        id: parse
        shell: bash
        run: |
          JSON='${{ steps.call.outputs.res }}'
          echo "Raw JSON:"
          echo "$JSON"

          MODEL=$(echo "$JSON" | jq -r '.model_call // "UNKNOWN"')
          CONF=$(echo "$JSON" | jq -r '.confidence // "0.0"')
          GUID=$(echo "$JSON" | jq -r '.guidance // "No guidance"')
          FEAT=$(echo "$JSON" | jq -c '.features // {}')

          echo "model=$MODEL"     >> "$GITHUB_OUTPUT"
          echo "confidence=$CONF" >> "$GITHUB_OUTPUT"
          echo "guidance=$GUID"   >> "$GITHUB_OUTPUT"
          echo "features=$FEAT"   >> "$GITHUB_OUTPUT"

      - name: Compose email text
        id: compose
        shell: bash
        run: |
          # Debug to logs so you can see values resolve
          echo "Model:      ${{ steps.parse.outputs.model }}"
          echo "Confidence: ${{ steps.parse.outputs.confidence }}"
          echo "Guidance:   ${{ steps.parse.outputs.guidance }}"
          echo "Features:   ${{ steps.parse.outputs.features }}"

          # Subject (single line)
          echo "subject=SPY Pre-Open: ${{ steps.parse.outputs.model }} (conf ${{ steps.parse.outputs.confidence }})" >> "$GITHUB_OUTPUT"

          # Body (multi-line)
          {
            echo "body<<EOF"
            echo "Direction: ${{ steps.parse.outputs.model }}"
            echo "Confidence: ${{ steps.parse.outputs.confidence }}"
            echo "Guidance: ${{ steps.parse.outputs.guidance }}"
            echo "Features: ${{ steps.parse.outputs.features }}"
            echo "Time: ${{ github.event.repository.updated_at }}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Email me the prediction
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to:       ${{ secrets.MAIL_USERNAME }}
          from:     "SPY Bot <${{ secrets.MAIL_USERNAME }}>"
          subject:  ${{ steps.compose.outputs.subject }}
          body:     ${{ steps.compose.outputs.body }}
